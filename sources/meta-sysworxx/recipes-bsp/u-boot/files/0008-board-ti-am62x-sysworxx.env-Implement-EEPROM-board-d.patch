From 9fa11a16733e7eecba9f3d04f85e629ff20270f1 Mon Sep 17 00:00:00 2001
From: Andreas Dinter <andreas.dinter@systec-electronic.com>
Date: Fri, 2 Aug 2024 15:28:49 +0200
Subject: [PATCH] board/ti/am62x/sysworxx.env: Implement EEPROM board detection

Signed-off-by: Andreas Dinter <andreas.dinter@systec-electronic.com>
---
 board/ti/am62x/sysworxx.c   | 15 ++++++++++++++-
 board/ti/am62x/sysworxx.env | 25 +++++++++++++++++++++++++
 2 files changed, 39 insertions(+), 1 deletion(-)

diff --git a/board/ti/am62x/sysworxx.c b/board/ti/am62x/sysworxx.c
index d0deddf879b..82fdcb23b3a 100644
--- a/board/ti/am62x/sysworxx.c
+++ b/board/ti/am62x/sysworxx.c
@@ -21,6 +21,7 @@
 #include <dm/uclass.h>
 #include <asm/gpio.h>
 #include <linux/delay.h>
+#include <command.h>
 
 #include "../common/fdt_ops.h"
 #include "../common/k3-ddr-init.h"
@@ -112,7 +113,19 @@ void reset_eth_phys(void) {
 #if CONFIG_IS_ENABLED(BOARD_LATE_INIT)
 int board_late_init(void)
 {
-	reset_eth_phys();
+	printf("EEPROM import\n");
+	int ret = run_command("run eeprom_import", CMD_FLAG_ENV);
+	if (ret == 0) {
+		char* fdt_prefix = env_get("fdt_prefix");
+		char* hw_iface_rev = env_get("hw_iface_rev");
+
+		if ((fdt_prefix != NULL) && (hw_iface_rev != NULL)) {
+			printf("fdt_prefix:   %s\n", fdt_prefix);
+			printf("hw_iface_rev: %s\n", hw_iface_rev);
+		}
+
+		reset_eth_phys();
+	}
 
 	return 0;
 }
diff --git a/board/ti/am62x/sysworxx.env b/board/ti/am62x/sysworxx.env
index 32c96d83e8b..e677c109094 100644
--- a/board/ti/am62x/sysworxx.env
+++ b/board/ti/am62x/sysworxx.env
@@ -6,6 +6,15 @@
 #include <env/ti/k3_rproc.env>
 #endif
 
+default_device_tree=ti/k3-am623-systec-fallback.dtb
+findfdt=
+	setenv name_fdt ${default_device_tree};
+	if test -n "$fdt_prefix" -a -n "$hw_iface_rev"; then
+		setenv name_fdt ti/${fdt_prefix}-rev${hw_iface_rev}.dtb;
+	fi;
+	setenv fdtfile ${name_fdt};
+	echo "Using fdtfile=$fdtfile"
+
 name_kern=Image
 console=ttyS2,115200n8
 args_all=setenv optargs ${optargs} earlycon=ns16550a,mmio32,0x02800000
@@ -23,6 +32,22 @@ splashfile=ti_logo_414x97_32bpp.bmp.gz
 splashimage=0x80200000
 splashpos=m,m
 splashsource=mmc
+
+eeprom_import=
+	echo "importing vendor data";
+	i2c dev 0;
+	i2c read 0x50 0x0.1 0x100 0x88080000;
+	i2c read 0x51 0x0.1 0x100 0x88080100;
+	env import -c 0x88080000 0x200 eeprom_layout fdt_prefix hw_iface_rev ethaddr eth1addr som_order_no som_bom_rev som_pcb_num som_serial_number dev_order_no dev_bom_rev dev_pcb_num dev_serial_number;
+	echo "vendor data imported"
+eeprom_export=
+	echo "exporting vendor data";
+	env export -c -s 0x200 0x88080000 eeprom_layout fdt_prefix hw_iface_rev ethaddr eth1addr som_order_no som_bom_rev som_pcb_num som_serial_number dev_order_no dev_bom_rev dev_pcb_num dev_serial_number;
+	i2c dev 0;
+	i2c write 0x88080000 0x50 0x0.1 0x100;
+	i2c write 0x88080100 0x51 0x0.1 0x100;
+	echo "vendor data exported"
+
 rproc_fw_binaries= 0 /lib/firmware/am62-mcu-m4f0_0-fw
 
 #if CONFIG_BOOTMETH_ANDROID
-- 
2.49.0

