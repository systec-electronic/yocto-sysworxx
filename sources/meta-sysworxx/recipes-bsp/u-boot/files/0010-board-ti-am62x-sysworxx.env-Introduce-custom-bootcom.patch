From bdb112fa6dba1093a43a90bf871784ffc08166af Mon Sep 17 00:00:00 2001
From: Andreas Dinter <andreas.dinter@systec-electronic.com>
Date: Sat, 22 Feb 2025 16:01:53 +0100
Subject: [PATCH] board/ti/am62x/sysworxx.env: Introduce custom bootcommand for
 boot sources

Signed-off-by: Andreas Dinter <andreas.dinter@systec-electronic.com>
---
 board/ti/am62x/sysworxx.env       | 21 ++++++++++++++++++++-
 configs/am625_sysworxx_a53.config |  1 +
 2 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/board/ti/am62x/sysworxx.env b/board/ti/am62x/sysworxx.env
index 6b4eefa2a43..821dafc5872 100644
--- a/board/ti/am62x/sysworxx.env
+++ b/board/ti/am62x/sysworxx.env
@@ -19,11 +19,13 @@ name_kern=Image
 console=ttyS2,115200n8
 args_all=setenv optargs ${optargs} earlycon=ns16550a,mmio32,0x02800000
 	${mtdparts}
+args_mmc=
+	setenv bootargs console=${console} ${optargs} root=${root_mmc} rw rootfstype=${mmcrootfstype}
+
 run_kern=booti ${loadaddr} ${rd_spec} ${fdtaddr}
 
 boot_targets=mmc1 mmc0 usb pxe dhcp
 boot=mmc
-bootpart=1:2
 bootdir=/boot
 rd_spec=-
 
@@ -47,6 +49,23 @@ eeprom_export=
 	i2c write 0x88080100 0x51 0x0.1 0x100;
 	echo "vendor data exported"
 
+mmc_detect=
+	mmc dev ${mmcdev};
+	if test ${mmcdev} -eq 1; then
+		echo "Boot from SD card";
+		env set bootpart 1:2;
+		env set root_mmc "/dev/mmcblk${mmcdev}p2";
+	else
+		echo "Boot from eMMC";
+		env set bootpart 0:1;
+		env set root_mmc "/dev/mmcblk${mmcdev}p1";
+	fi
+
+bootcmd_sysworxx=
+	run mmc_detect;
+	run findfdt;
+	run bootcmd_ti_mmc;
+
 rproc_fw_binaries= 0 /lib/firmware/am62-mcu-m4f0_0-fw
 
 #if CONFIG_BOOTMETH_ANDROID
diff --git a/configs/am625_sysworxx_a53.config b/configs/am625_sysworxx_a53.config
index a07a69ade7e..60aa63495df 100644
--- a/configs/am625_sysworxx_a53.config
+++ b/configs/am625_sysworxx_a53.config
@@ -2,3 +2,4 @@
 
 CONFIG_TARGET_SYSWORXX_AM62X_ADOPT=y
 CONFIG_ENV_SOURCE_FILE="sysworxx"
+CONFIG_BOOTCOMMAND="run bootcmd_sysworxx;"
-- 
2.48.1

