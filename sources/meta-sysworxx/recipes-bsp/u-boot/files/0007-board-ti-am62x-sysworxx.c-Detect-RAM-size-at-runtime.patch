From b9362ec20352aa0343c26f697af44477eecc6f96 Mon Sep 17 00:00:00 2001
From: Andreas Dinter <andreas.dinter@systec-electronic.com>
Date: Thu, 16 Jan 2025 16:50:42 +0100
Subject: [PATCH] board/ti/am62x/sysworxx.c: Detect RAM size at runtime

Removing spl_perform_fixups and adjusting the Makefile is needed to
avoid compiler and linker errors. Supported devices do not use ECC RAM
so we should be fine.

Signed-off-by: Andreas Dinter <andreas.dinter@systec-electronic.com>
---
 board/ti/am62x/sysworxx.c | 31 +++++++++++++++++++++++--------
 board/ti/common/Makefile  |  2 ++
 2 files changed, 25 insertions(+), 8 deletions(-)

diff --git a/board/ti/am62x/sysworxx.c b/board/ti/am62x/sysworxx.c
index a9214697b29..d0deddf879b 100644
--- a/board/ti/am62x/sysworxx.c
+++ b/board/ti/am62x/sysworxx.c
@@ -27,6 +27,27 @@
 
 DECLARE_GLOBAL_DATA_PTR;
 
+/*
+ * RAM size is detected at runtime. Maximum RAM size is 2G.
+ * - dram_init() is called in board_f.c/board_init_f()
+ * - ft_board_setup() is called in image-fdt.c/image_setup_libfdt()
+ * - bank sizes will be initialized by default implementations.
+ *		board_init_f()
+ *      -> dram_init_banksize()
+ *         -> get_effective_memsize()
+ *            -> returns gd->ram_size
+ */
+
+#define CFG_SYS_SDRAM_BASE		0x80000000
+#define CFG_SYS_SDRAM_SIZE_MAX	SZ_2G
+
+int dram_init(void)
+{
+	gd->ram_size = get_ram_size((long *)CFG_SYS_SDRAM_BASE, CFG_SYS_SDRAM_SIZE_MAX);
+	printf("Detected RAM size: 0x%08x\n", gd->ram_size);
+	return 0;
+}
+
 #if CONFIG_IS_ENABLED(SPLASH_SCREEN)
 static struct splash_location default_splash_locations[] = {
 	{
@@ -116,14 +137,6 @@ void spl_board_init(void)
 	if (IS_ENABLED(CONFIG_SPL_SPLASH_SCREEN) && IS_ENABLED(CONFIG_SPL_BMP))
 		splash_display();
 }
-
-void spl_perform_fixups(struct spl_image_info *spl_image)
-{
-	if (IS_ENABLED(CONFIG_K3_DDRSS) && IS_ENABLED(CONFIG_K3_INLINE_ECC))
-		fixup_ddr_driver_for_ecc(spl_image);
-	else
-		fixup_memory_node(spl_image);
-}
 #endif
 
 #if defined(CONFIG_OF_BOARD_SETUP)
@@ -131,6 +144,8 @@ int ft_board_setup(void *blob, struct bd_info *bd)
 {
 	int ret = -1;
 
+	fdt_fixup_memory(blob, (u64)CFG_SYS_SDRAM_BASE, (u64)gd->ram_size);
+
 	if (IS_ENABLED(CONFIG_FDT_SIMPLEFB))
 		ret = fdt_simplefb_enable_and_mem_rsv(blob);
 
diff --git a/board/ti/common/Makefile b/board/ti/common/Makefile
index 070dec3aebf..5c4a5dc6d00 100644
--- a/board/ti/common/Makefile
+++ b/board/ti/common/Makefile
@@ -4,4 +4,6 @@
 obj-${CONFIG_TI_I2C_BOARD_DETECT} += board_detect.o
 obj-${CONFIG_CMD_EXTENSION} += cape_detect.o
 obj-${CONFIG_OF_LIBFDT} += fdt_ops.o
+ifndef CONFIG_TARGET_SYSWORXX_AM62X_ADOPT
 obj-${CONFIG_ARCH_K3} += k3-ddr-init.o
+endif
-- 
2.48.1

