From d3e1aaa5361d2954495af8a4514d7a77273d0746 Mon Sep 17 00:00:00 2001
From: Andreas Dinter <andreas.dinter@systec-electronic.com>
Date: Fri, 2 Aug 2024 15:28:49 +0200
Subject: [PATCH 07/13] board/ti/am62x/sysworxx.env: Load u-boot environment
 for board detection

Signed-off-by: Andreas Dinter <andreas.dinter@systec-electronic.com>
---
 board/ti/am62x/sysworxx.env | 26 ++++++++++++++++++++++++++
 1 file changed, 26 insertions(+)

diff --git a/board/ti/am62x/sysworxx.env b/board/ti/am62x/sysworxx.env
index 32c96d83e8b..d69a1cc03ee 100644
--- a/board/ti/am62x/sysworxx.env
+++ b/board/ti/am62x/sysworxx.env
@@ -6,6 +6,16 @@
 #include <env/ti/k3_rproc.env>
 #endif
 
+default_device_tree=ti/k3-am623-systec-fallback.dtb
+bootcmd=run eeprom_import; run envboot; run distro_bootcmd;
+findfdt=
+	setenv name_fdt ${default_device_tree};
+	if test -n "$fdt_prefix" -a -n "$hw_iface_rev"; then
+		setenv name_fdt ti/${fdt_prefix}-rev${hw_iface_rev}.dtb;
+	fi;
+	setenv fdtfile ${name_fdt};
+	echo "Using fdtfile=$fdtfile"
+
 name_kern=Image
 console=ttyS2,115200n8
 args_all=setenv optargs ${optargs} earlycon=ns16550a,mmio32,0x02800000
@@ -23,6 +33,22 @@ splashfile=ti_logo_414x97_32bpp.bmp.gz
 splashimage=0x80200000
 splashpos=m,m
 splashsource=mmc
+
+eeprom_import=
+	echo "importing vendor data";
+	i2c dev 0;
+	i2c read 0x50 0x0.1 0x100 0x88080000;
+	i2c read 0x51 0x0.1 0x100 0x88080100;
+	env import -c 0x88080000 0x200 eeprom_layout fdt_prefix hw_iface_rev ethaddr eth1addr som_order_no som_bom_rev som_pcb_num som_serial_number dev_order_no dev_bom_rev dev_pcb_num dev_serial_number;
+	echo "vendor data imported"
+eeprom_export=
+	echo "exporting vendor data";
+	env export -c -s 0x200 0x88080000 eeprom_layout fdt_prefix hw_iface_rev ethaddr eth1addr som_order_no som_bom_rev som_pcb_num som_serial_number dev_order_no dev_bom_rev dev_pcb_num dev_serial_number;
+	i2c dev 0;
+	i2c write 0x88080000 0x50 0x0.1 0x100;
+	i2c write 0x88080100 0x51 0x0.1 0x100;
+	echo "vendor data exported"
+
 rproc_fw_binaries= 0 /lib/firmware/am62-mcu-m4f0_0-fw
 
 #if CONFIG_BOOTMETH_ANDROID
-- 
2.47.0

