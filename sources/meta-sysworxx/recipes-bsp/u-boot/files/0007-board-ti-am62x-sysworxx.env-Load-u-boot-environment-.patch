From 5494fb6ad9476bcc5e153e10a08ee8f65e2c9040 Mon Sep 17 00:00:00 2001
From: Andreas Dinter <andreas.dinter@systec-electronic.com>
Date: Fri, 2 Aug 2024 15:28:49 +0200
Subject: [PATCH 7/9] board/ti/am62x/sysworxx.env: Load u-boot environment for
 board detection

Signed-off-by: Andreas Dinter <andreas.dinter@systec-electronic.com>
---
 board/ti/am62x/sysworxx.env | 36 ++++++++++++++++++++++--------------
 1 file changed, 22 insertions(+), 14 deletions(-)

diff --git a/board/ti/am62x/sysworxx.env b/board/ti/am62x/sysworxx.env
index 857d558c305..5c8819ff8ae 100644
--- a/board/ti/am62x/sysworxx.env
+++ b/board/ti/am62x/sysworxx.env
@@ -7,22 +7,15 @@
 #include <environment/ti/k3_rproc.env>
 #endif
 
-default_device_tree=ti/k3-am625-sk.dtb
+default_device_tree=ti/k3-am623-systec-fallback.dtb
+bootcmd=run eeprom_import; run envboot; run distro_bootcmd;
 findfdt=
 	setenv name_fdt ${default_device_tree};
-	if test $board_name = am62x_skevm; then
-			setenv name_fdt ti/k3-am625-sk.dtb; fi;
-	if test $board_name = am62b_p1_skevm; then
-			setenv name_fdt ti/k3-am625-sk.dtb; fi;
-	if test $board_name = am62x_sip_skevm; then
-                        setenv name_fdt ti/k3-am625-sk.dtb; fi;
-	if test $board_name = am62x_lp_skevm; then
-			setenv name_fdt ti/k3-am62-lp-sk.dtb; fi;
-	if test $board_name = am62x_beagleplay; then
-			setenv name_fdt ti/k3-am625-beagleplay.dtb; fi;
-	if test $board_name = am62x_sysworxx_ctr; then
-			setenv name_fdt ti/k3-am623-systec-ctr800-rev0.dtb; fi;
-	setenv fdtfile ${name_fdt}
+	if test -n "$fdt_prefix" -a -n "$hw_iface_rev"; then
+		setenv name_fdt ti/${fdt_prefix}-rev${hw_iface_rev}.dtb;
+	fi;
+	setenv fdtfile ${name_fdt};
+	echo "Using fdtfile=$fdtfile"
 name_kern=Image
 console=ttyS2,115200n8
 args_all=setenv optargs ${optargs} earlycon=ns16550a,mmio32,0x02800000
@@ -40,6 +33,21 @@ splashimage=0x80200000
 splashpos=m,m
 splashsource=mmc
 
+eeprom_import=
+	echo "importing vendor data";
+	i2c dev 0;
+	i2c read 0x50 0x0.1 0x100 0x88080000;
+	i2c read 0x51 0x0.1 0x100 0x88080100;
+	env import -c 0x88080000 0x200 eeprom_layout fdt_prefix hw_iface_rev ethaddr eth1addr som_order_no som_bom_rev som_pcb_num som_serial_number dev_order_no dev_bom_rev dev_pcb_num dev_serial_number;
+	echo "vendor data imported"
+eeprom_export=
+	echo "exporting vendor data";
+	env export -c -s 0x200 0x88080000 eeprom_layout fdt_prefix hw_iface_rev ethaddr eth1addr som_order_no som_bom_rev som_pcb_num som_serial_number dev_order_no dev_bom_rev dev_pcb_num dev_serial_number;
+	i2c dev 0;
+	i2c write 0x88080000 0x50 0x0.1 0x100;
+	i2c write 0x88080100 0x51 0x0.1 0x100;
+	echo "vendor data exported"
+
 rproc_fw_binaries= 0 /lib/firmware/am62-mcu-m4f0_0-fw
 
 #if CONFIG_CMD_ABOOTIMG
-- 
2.46.0

