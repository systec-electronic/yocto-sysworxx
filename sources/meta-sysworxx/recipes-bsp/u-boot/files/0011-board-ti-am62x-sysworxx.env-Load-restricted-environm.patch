From cf2afa2015dc19875357e4d820e0d2943a6e9a11 Mon Sep 17 00:00:00 2001
From: Andreas Dinter <andreas.dinter@systec-electronic.com>
Date: Sat, 22 Feb 2025 16:07:58 +0100
Subject: [PATCH] board/ti/am62x/sysworxx.env: Load restricted environment from
 eMMC boot partition

Signed-off-by: Andreas Dinter <andreas.dinter@systec-electronic.com>
---
 board/ti/am62x/sysworxx.env | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/board/ti/am62x/sysworxx.env b/board/ti/am62x/sysworxx.env
index cf3e27709d4..b174f72d2cb 100644
--- a/board/ti/am62x/sysworxx.env
+++ b/board/ti/am62x/sysworxx.env
@@ -61,8 +61,20 @@ mmc_detect=
 		env set root_mmc "/dev/mmcblk${mmcdev}p1";
 	fi
 
+env_import=
+	if test ! -e mmc ${mmcdev}:2 uboot.env; then
+		echo Initialize uboot.env;
+		run env_export;
+	fi;
+	fatload mmc ${mmcdev}:2 0x88080000 uboot.env 0x4000;
+	env import -c 0x88080000 0x4000 name_overlays;
+env_export=
+	env export -c -s 0x4000 0x88080000 name_overlays;
+	fatwrite mmc ${mmcdev}:2 0x88080000 uboot.env 0x4000;
+
 bootcmd_sysworxx=
 	run mmc_detect;
+	run env_import;
 	run findfdt;
 	run bootcmd_ti_mmc;
 
-- 
2.48.1

