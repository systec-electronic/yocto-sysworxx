---
default:
  image: ${CI_REGISTRY}/132335/sw/yocto-builder:latest
  tags: [docker, yocto]

variables:
  FF_DISABLE_UMASK_FOR_DOCKER_EXECUTOR: true
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_DEPTH: 0
  # don't clean Yocto build/tmp directory per default
  GIT_CLEAN_FLAGS: -ffdx -e build/

stages:
  - build
  - deploy

before_script:
  - echo 'DL_DIR="/cache/downloads"' >> ./build/conf/local.conf
  - echo 'SSTATE_DIR="/cache/sstate-cache"' >> ./build/conf/local.conf
  - cp -v $RAUC_CRT rauc-ca/rauc.crt
  - cp -v $RAUC_KEY rauc-ca/rauc.key

sysworxx-image-default:
  stage: build
  script: |
    cd build/
    . conf/setenv
    bitbake sysworxx-image-default
    cp deploy-ti/images/sysworxx/sysworxx-image-default-sysworxx.rootfs.wic.xz ..
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    when: on_success
    expire_in: 1 week
    paths:
      - "*.wic.xz"

bare-repo-release:
  stage: deploy
  image:
    name: alpine
  variables:
    GIT_STRATEGY: clone
    GIT_CHECKOUT: "false"
  before_script:
    - |
      mkdir -p /cache/apk/
      apk add --cache-dir /cache/apk/ git
  script:
    - |
      describe="${CI_COMMIT_TAG:-${CI_COMMIT_BRANCH}}-${CI_COMMIT_SHORT_SHA}"
      gitc="git -C "${CI_PROJECT_NAME}.git""
      project_url=$(git -C .git/ remote -v | grep fetch | awk '{print $2}')
      rm -r .git

      git clone --bare ${project_url} "${CI_PROJECT_NAME}.git"

      if [[ -n "${CI_COMMIT_BRANCH}" && "${CI_COMMIT_BRANCH}" != "${CI_DEFAULT_BRANCH}" ]]; then
        $gitc branch | grep -v -e "${CI_DEFAULT_BRANCH}" -e ${CI_COMMIT_BRANCH} | xargs $gitc branch -D
      else
        $gitc branch | grep -v -e "${CI_DEFAULT_BRANCH}" | xargs $gitc branch -D
      fi
      $gitc gc
      $gitc remote remove origin

      echo branches:
      $gitc branch
      echo tags:
      $gitc tag

      tar jcfv "${CI_PROJECT_NAME}-${describe}.tar.bz2" "${CI_PROJECT_NAME}.git"
      tar zcfv "${CI_PROJECT_NAME}-${describe}.tar.gz" "${CI_PROJECT_NAME}.git"
  artifacts:
    paths:
      - "./${CI_PROJECT_NAME}-*.tar.*"
